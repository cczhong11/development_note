{"pageProps":{"note":{"id":"aar1sktn882l7ik25bq09gi","title":"quantize","desc":"","updated":1753335870007,"created":1687625469268,"custom":{},"fname":"development.ml.LLM.llama.quantize","type":"note","vault":{"fsPath":"repos/dendron-aws-vault","remote":{"type":"git","url":"https://github.com/cczhong11/my_note.git"},"name":"my_note"},"contentHash":"15dd17c05e7ded4777285c6e7f00bed9","links":[],"anchors":{"-1-pretrain-é‡åŒ–pretraining-quantization":{"type":"header","text":"ğŸ§  1. Pretrain é‡åŒ–ï¼ˆPretraining Quantizationï¼‰","value":"-1-pretrain-é‡åŒ–pretraining-quantization","line":10,"column":0,"depth":2},"-2-lora-é‡åŒ–low-rank-adaptation--quantization":{"type":"header","text":"ğŸ 2. LoRA é‡åŒ–ï¼ˆLow-Rank Adaptation + Quantizationï¼‰","value":"-2-lora-é‡åŒ–low-rank-adaptation--quantization","line":23,"column":0,"depth":2},"-3-ffn-only-é‡åŒ–æ¯”å¦‚-outlier-aware-quantization":{"type":"header","text":"ğŸ’¡ 3. FFN-only é‡åŒ–ï¼ˆæ¯”å¦‚ Outlier-Aware Quantizationï¼‰","value":"-3-ffn-only-é‡åŒ–æ¯”å¦‚-outlier-aware-quantization","line":40,"column":0,"depth":2},"ï¸-4-æ¨ç†é˜¶æ®µé‡åŒ–serving-time-quantization":{"type":"header","text":"ğŸ›°ï¸ 4. æ¨ç†é˜¶æ®µé‡åŒ–ï¼ˆServing-time Quantizationï¼‰","value":"ï¸-4-æ¨ç†é˜¶æ®µé‡åŒ–serving-time-quantization","line":55,"column":0,"depth":2},"-å¸¸è§-serving-é‡åŒ–æ–¹æ³•":{"type":"header","text":"âœ¨ å¸¸è§ serving é‡åŒ–æ–¹æ³•ï¼š","value":"-å¸¸è§-serving-é‡åŒ–æ–¹æ³•","line":59,"column":0,"depth":3},"-serving-çš„ç›®æ ‡":{"type":"header","text":"ğŸš€ Serving çš„ç›®æ ‡ï¼š","value":"-serving-çš„ç›®æ ‡","line":67,"column":0,"depth":3},"-æ€»ç»“ä¸€å¼ å›¾é€»è¾‘æµ":{"type":"header","text":"ğŸ° æ€»ç»“ä¸€å¼ å›¾ï¼ˆé€»è¾‘æµï¼‰ï¼š","value":"-æ€»ç»“ä¸€å¼ å›¾é€»è¾‘æµ","line":75,"column":0,"depth":2},"-å°è´´å£«-time-":{"type":"header","text":"ğŸ’¬ å°è´´å£« Time ï½","value":"-å°è´´å£«-time-","line":91,"column":0,"depth":2}},"children":[],"parent":"9cp08wuyd7t35jzracxxqbv","data":{}},"body":"<h1 id=\"quantize\">quantize<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#quantize\"></a></h1>\n<h2 id=\"-1-pretrain-é‡åŒ–pretraining-quantization\">ğŸ§  1. Pretrain é‡åŒ–ï¼ˆPretraining Quantizationï¼‰<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#-1-pretrain-é‡åŒ–pretraining-quantization\"></a></h2>\n<p>åŸå§‹è®­ç»ƒçš„æ—¶å€™ï¼Œæ¨¡å‹å‚æ•°éƒ½æ˜¯ç”¨ <strong>float32</strong> è¡¨ç¤ºçš„ï¼Œè™½ç„¶å¾ˆç²¾ç¡®ï¼Œä½†è¶…çº§å å†…å­˜ğŸ¥²</p>\n<p>ä¸ºäº†è®©è®­ç»ƒæ›´å¿«ã€æ›´çœæ˜¾å­˜ï¼Œç°åœ¨æœ‰äº›ç ”ç©¶å¼€å§‹æ¢ç´¢ï¼š</p>\n<ul>\n<li><strong>Quantization-aware training (QAT)</strong>ï¼šåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­æ¨¡æ‹Ÿä½ç²¾åº¦ï¼ˆæ¯”å¦‚ fp8ã€int8ï¼‰çš„æ•ˆæœï¼Œæå‰é€‚åº”ã€‚</li>\n<li><strong>PTQ (Post-training quantization)</strong>ï¼šè®­ç»ƒå®Œå†é‡åŒ–ï¼Œä½†é¢„è®­ç»ƒé˜¶æ®µå¾ˆå°‘è¿™ä¹ˆåšï¼Œå› ä¸ºä¼šæŸä¼¤æ¨¡å‹æ€§èƒ½ã€‚</li>\n</ul>\n<p>ä¸è¿‡ LLaMA çš„å®˜æ–¹é¢„è®­ç»ƒæ¨¡å‹ä¸€èˆ¬è¿˜æ˜¯ float16/float32ï¼ŒçœŸæ­£çš„é‡åŒ–éƒ½æ˜¯<strong>è®­ç»ƒå®Œä¹‹ååšçš„</strong>ï¼</p>\n<hr>\n<h2 id=\"-2-lora-é‡åŒ–low-rank-adaptation--quantization\">ğŸ 2. LoRA é‡åŒ–ï¼ˆLow-Rank Adaptation + Quantizationï¼‰<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#-2-lora-é‡åŒ–low-rank-adaptation--quantization\"></a></h2>\n<p>LoRA æ˜¯ä¸€ç§ã€Œä½ç§©å¾®è°ƒã€çš„æ–¹æ³•ï¼Œå®ƒå†»ç»“åŸå§‹æ¨¡å‹ï¼Œåªè®­ç»ƒå°å°çš„ adapter ğŸ“¦</p>\n<p>ğŸ‘‰ æ‰€ä»¥é‡åŒ–åˆ†ä¸¤å—ï¼š</p>\n<ol>\n<li><strong>åŸå§‹æ¨¡å‹å‚æ•°</strong>å¯ä»¥é‡åŒ–æˆ int8 / int4ï¼ˆæ¯”å¦‚ç”¨ GPTQã€AWQã€Exllama2ï¼‰</li>\n<li><strong>LoRA adapter</strong> é€šå¸¸ä¿ç•™ä¸º float16ï¼ˆå› ä¸ºå¾ˆå°ï½ï¼‰</li>\n</ol>\n<p>è¿™ç§æ–¹å¼ä½ å¯ä»¥è¾¹é‡åŒ–è¾¹å¾®è°ƒï¼Œæˆ–è€…ï¼š</p>\n<ul>\n<li>å…ˆé‡åŒ– float æ¨¡å‹</li>\n<li>å†ç”¨ LoRA åšå°‘é‡å¾®è°ƒ</li>\n<li>æ¨ç†æ—¶åŠ è½½é‡åŒ–æ¨¡å‹ + float16 çš„ adapter ğŸ’¡</li>\n</ul>\n<hr>\n<h2 id=\"-3-ffn-only-é‡åŒ–æ¯”å¦‚-outlier-aware-quantization\">ğŸ’¡ 3. FFN-only é‡åŒ–ï¼ˆæ¯”å¦‚ Outlier-Aware Quantizationï¼‰<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#-3-ffn-only-é‡åŒ–æ¯”å¦‚-outlier-aware-quantization\"></a></h2>\n<p>åœ¨ LLaMA ä¸­ï¼Œ<strong>Feed-Forward Networkï¼ˆFFNï¼‰å±‚çš„æ¿€æ´»å€¼åˆ†å¸ƒç‰¹åˆ«â€œçˆ†ç‚¸â€ğŸ’¥ï¼Œæœ‰å¾ˆå¤š outlierï¼ˆå¼‚å¸¸å€¼ï¼‰</strong></p>\n<p>æ‰€ä»¥å¤§å®¶å‘ç°å¯ä»¥åªé‡åŒ–è¿™äº›éƒ¨åˆ†ï¼š</p>\n<ul>\n<li>ä½¿ç”¨ <strong>group-wise quantization</strong>ï¼ˆåˆ†ç»„é‡åŒ–ï¼‰æ¥å¤„ç† outlier</li>\n<li>æˆ–è€…åªé‡åŒ– Attentionï¼Œä¸é‡åŒ– FFN</li>\n</ul>\n<p>ğŸ‘‰ æ¯”å¦‚ <a href=\"https://arxiv.org/abs/2306.00978\">AWQ</a> å’Œ <a href=\"https://arxiv.org/abs/2211.10438\">SmoothQuant</a> éƒ½å¯¹ FFN åšç‰¹æ®Šå¤„ç†ï¼</p>\n<p>ç›®çš„å°±æ˜¯ï¼š<strong>ä¿ç•™é‡è¦çš„ç²¾åº¦ï¼ŒåŒæ—¶å‹ç¼©æ¨¡å‹å¤§å° âœ¨</strong></p>\n<hr>\n<h2 id=\"ï¸-4-æ¨ç†é˜¶æ®µé‡åŒ–serving-time-quantization\">ğŸ›°ï¸ 4. æ¨ç†é˜¶æ®µé‡åŒ–ï¼ˆServing-time Quantizationï¼‰<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#ï¸-4-æ¨ç†é˜¶æ®µé‡åŒ–serving-time-quantization\"></a></h2>\n<p>åˆ°äº†çœŸæ­£ä¸Šçº¿éƒ¨ç½²ï¼ˆservingï¼‰çš„æ—¶å€™ï¼Œé‡åŒ–å°±è¶…é‡è¦äº†ï¼è¿™é‡Œä¸€èˆ¬ç”¨ï¼š</p>\n<h3 id=\"-å¸¸è§-serving-é‡åŒ–æ–¹æ³•\">âœ¨ å¸¸è§ serving é‡åŒ–æ–¹æ³•ï¼š<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#-å¸¸è§-serving-é‡åŒ–æ–¹æ³•\"></a></h3>\n<ul>\n<li><strong>GPTQ</strong>ï¼šç¦»çº¿é‡åŒ–ï¼Œå¾ˆå¿«ä½†æœ‰äº›æŸç²¾åº¦</li>\n<li><strong>AWQ</strong>ï¼šè€ƒè™‘ outlierï¼Œé€‚åˆ FFN å±‚ï¼Œæ€§èƒ½å’Œç²¾åº¦æ›´å¹³è¡¡</li>\n<li><strong>Exllama / Exllama2</strong>ï¼šä¸“ä¸º LLaMA ä¼˜åŒ–çš„ int4 åç«¯ï¼ˆå·¨å¿«ï¼‰</li>\n<li><strong>AutoGPTQ</strong>ï¼šæ”¯æŒ HuggingFaceï¼Œæ˜“ç”¨ï¼</li>\n<li><strong>MLC / vLLM / TensorRT-LLM</strong>ï¼šéƒ¨ç½²ç¥å™¨ï¼Œæ”¯æŒä¸åŒç¡¬ä»¶åç«¯ï¼</li>\n</ul>\n<h3 id=\"-serving-çš„ç›®æ ‡\">ğŸš€ Serving çš„ç›®æ ‡ï¼š<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#-serving-çš„ç›®æ ‡\"></a></h3>\n<ul>\n<li>å†…å­˜å ç”¨ä½ï¼ˆint4 ä¸€èˆ¬åªæœ‰åŸæ¥ 1/8ï¼‰</li>\n<li>ååé‡é«˜ï¼ˆæ›´å¤š token/sï¼‰</li>\n<li>ç²¾åº¦æŸå¤±å°½å¯èƒ½å°</li>\n</ul>\n<hr>\n<h2 id=\"-æ€»ç»“ä¸€å¼ å›¾é€»è¾‘æµ\">ğŸ° æ€»ç»“ä¸€å¼ å›¾ï¼ˆé€»è¾‘æµï¼‰ï¼š<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#-æ€»ç»“ä¸€å¼ å›¾é€»è¾‘æµ\"></a></h2>\n<pre><code>[Pretraining] (float32/fp16)\n      â†“\n[Post-training Quantization] â†’ GPTQ, AWQ\n      â†“\n[Optional: LoRA Fine-tuning]\n      â†“\n[FFN-aware Optimizations] â†’ SmoothQuant, AWQ\n      â†“\n[Serving] â†’ Exllama2, AutoGPTQ, vLLM, MLC\n</code></pre>\n<hr>\n<h2 id=\"-å°è´´å£«-time-\">ğŸ’¬ å°è´´å£« Time ï½<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#-å°è´´å£«-time-\"></a></h2>\n<ul>\n<li>æƒ³ç”¨ int4 LLaMA å¯ä»¥ç›´æ¥è¯•è¯• Huggingface ä¸Šçš„ <a href=\"https://huggingface.co/TheBloke\">GGUF æ¨¡å‹</a>ï¼Œé…åˆ <code>llama.cpp</code> æˆ– <code>Exllama</code> åç«¯ç”¨è¶…çˆ½ï½</li>\n<li>ä¸åŒé‡åŒ–æ–¹æ¡ˆé€‚åˆä¸åŒçš„æ˜¾å¡æˆ–ç¡¬ä»¶å¹³å°å“¦ï¼Œè¦çœ‹æ˜¯ CPU/GPU è¿˜æ˜¯æ‰‹æœº ğŸ“±</li>\n<li>æ¨ç†çš„æ—¶å€™ batch size å’Œ quant scheme é€‰å¾—å¥½ï¼Œå¯ä»¥å¿« 3~5 å€ï¼</li>\n</ul>","noteIndex":{"id":"0f1b48c7-3a25-4016-83a5-15864d7803ad","title":"Development","vault":{"fsPath":"repos/dendron-aws-vault","remote":{"type":"git","url":"https://github.com/cczhong11/my_note.git"},"name":"my_note"},"type":"note","desc":"","links":[{"from":{"fname":"root","id":"c95dc4f5-23db-45e7-a15b-64582a183ccc","vaultName":"my_note"},"type":"backlink","position":{"start":{"line":8,"column":3,"offset":63},"end":{"line":8,"column":21,"offset":81},"indent":[]},"value":"development"}],"anchors":{},"fname":"development","updated":1618381238346,"created":1612940782409,"parent":null,"children":["400115e9-30f7-4a13-9776-db059bc9cd42","xsX5v3ZsyJ0i6gf9","1bc3b45a-b6f4-4150-87d3-5bd5b6eb8c24","6cea4852-6e7c-4140-b476-85c07b48a642","a40ef849-d301-4d74-a778-e6d9469dfb5d","09d9081f-3dff-453d-8488-7d2344cc8895","p11phg7nb10yw0wck1fyagq","92917ea3-452e-48dc-875e-5cd0002041db","2e151826-cb22-4d89-8ce0-71dad7204ce8","baa39444-0da9-4c55-8df7-2a6f8f787fa4","q4um3bc3st86ilkkvdjom6x","62daf50d-a39e-463f-aabd-be53790281fd","3524d0a7-be73-45d6-847e-c970f5c1c760","eac0f243-05b3-4b95-bec3-848e33edbc40","zrjuka02gkzrqxt5djp2aws"],"data":{},"custom":{"nav_order":0,"permalink":"/"},"body":"\n","contentHash":"38357962f5a50c6fd7d318dfa66bea90"},"collectionChildren":null,"customHeadContent":null,"config":{"version":5,"dev":{"previewV2Enabled":false,"enablePreviewV2":true},"commands":{"lookup":{"note":{"selectionMode":"extract","confirmVaultOnCreate":false,"leaveTrace":false,"bubbleUpCreateNew":true,"fuzzThreshold":0.2,"vaultSelectionModeOnCreate":"smart"}},"insertNote":{"initialValue":"templates"},"insertNoteLink":{"aliasMode":"none","enableMultiSelect":false},"insertNoteIndex":{"enableMarker":false},"randomNote":{},"copyNoteLink":{"aliasMode":"title"},"templateHierarchy":"template"},"workspace":{"dendronVersion":"0.90.0","vaults":[{"fsPath":"repos/dendron-aws-vault","remote":{"type":"git","url":"https://github.com/cczhong11/my_note.git"},"name":"my_note"},{"fsPath":"vault"}],"journal":{"dailyDomain":"daily","name":"journal","dateFormat":"y.MM.dd","addBehavior":"childOfDomain"},"scratch":{"name":"scratch","dateFormat":"y.MM.dd.HHmmss","addBehavior":"asOwnDomain"},"graph":{"zoomSpeed":1,"createStub":false},"enableAutoCreateOnDefinition":false,"enableXVaultWikiLink":false,"enableRemoteVaultInit":true,"workspaceVaultSyncMode":"noCommit","enableAutoFoldFrontmatter":true,"maxPreviewsCached":10,"maxNoteLength":204800,"enableUserTags":true,"enableHashTags":true,"task":{"name":"","dateFormat":"","addBehavior":"childOfCurrent","statusSymbols":{"":" ","wip":"w","done":"x","assigned":"a","moved":"m","blocked":"b","delegated":"l","dropped":"d","pending":"y"},"prioritySymbols":{"H":"high","M":"medium","L":"low"},"todoIntegration":false,"createTaskSelectionType":"selection2link","taskCompleteStatus":["done","x"]},"enableEditorDecorations":true,"enableHandlebarTemplates":true,"enableFullHierarchyNoteTitle":false,"enablePersistentHistory":false},"preview":{"enableFMTitle":true,"enableNoteTitleForLink":true,"enableMermaid":true,"enablePrettyRefs":true,"enableKatex":true,"enableFrontmatterTags":true,"enableHashesForFMTags":false,"automaticallyShowPreview":false},"publishing":{"enableFMTitle":true,"enableNoteTitleForLink":true,"enablePrettyRefs":true,"enableKatex":true,"copyAssets":true,"siteHierarchies":["development","life"],"writeStubs":false,"siteRootDir":"docs","seo":{"title":"my_note","description":"Personal knowledge space"},"github":{"enableEditLink":true,"editLinkText":"Edit this page on GitHub","editBranch":"main","editViewMode":"tree"},"enableSiteLastModified":true,"enableFrontmatterTags":true,"enableHashesForFMTags":false,"enableRandomlyColoredTags":true,"enableTaskNotes":true,"enablePrettyLinks":true,"searchMode":"lookup","enableMermaid":true,"siteUrl":"https://notes.tczhong.com","siteFaviconPath":"favicon.ico","siteIndex":"development"}}},"__N_SSG":true}