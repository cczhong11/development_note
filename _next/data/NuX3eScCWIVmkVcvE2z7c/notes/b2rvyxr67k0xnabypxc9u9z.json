{"pageProps":{"note":{"id":"b2rvyxr67k0xnabypxc9u9z","title":"qlora","desc":"","updated":1753335919911,"created":1687625458019,"custom":{},"fname":"development.ml.LLM.llama.qlora","type":"note","vault":{"fsPath":"repos/dendron-aws-vault","remote":{"type":"git","url":"https://github.com/cczhong11/my_note.git"},"name":"my_note"},"contentHash":"7ce0cf4a8d3bfc4325fd698b2dac75ab","links":[],"anchors":{"-ä»€ä¹ˆæ˜¯-qlora":{"type":"header","text":"ğŸ§  ä»€ä¹ˆæ˜¯ QLoRAï¼Ÿ","value":"-ä»€ä¹ˆæ˜¯-qlora","line":9,"column":0,"depth":2},"-å®ƒæ€ä¹ˆåšçš„å†…éƒ¨æœºåˆ¶è®²è§£-":{"type":"header","text":"ğŸ§© å®ƒæ€ä¹ˆåšçš„ï¼Ÿå†…éƒ¨æœºåˆ¶è®²è§£ ğŸ‘‡","value":"-å®ƒæ€ä¹ˆåšçš„å†…éƒ¨æœºåˆ¶è®²è§£-","line":20,"column":0,"depth":2},"-qlora-æ ¸å¿ƒ-idea":{"type":"header","text":"ğŸ’¡ QLoRA æ ¸å¿ƒ ideaï¼š","value":"-qlora-æ ¸å¿ƒ-idea","line":22,"column":0,"depth":3},"-qlora-è¯¦ç»†æµç¨‹":{"type":"header","text":"ğŸ§ª QLoRA è¯¦ç»†æµç¨‹","value":"-qlora-è¯¦ç»†æµç¨‹","line":30,"column":0,"depth":2},"-qlora-vs-lora-vs-gptq":{"type":"header","text":"ğŸ§  QLoRA vs LoRA vs GPTQ","value":"-qlora-vs-lora-vs-gptq","line":41,"column":0,"depth":2},"-ä½¿ç”¨-qlora-çš„å·¥å…·æ¨è":{"type":"header","text":"ğŸ”§ ä½¿ç”¨ QLoRA çš„å·¥å…·æ¨è","value":"-ä½¿ç”¨-qlora-çš„å·¥å…·æ¨è","line":51,"column":0,"depth":2},"-ä¼˜åŠ¿æ€»ç»“ä¸ºå•¥å¤§å®¶éƒ½ç”¨-qlora":{"type":"header","text":"âœ¨ ä¼˜åŠ¿æ€»ç»“ï¼ˆä¸ºå•¥å¤§å®¶éƒ½ç”¨ QLoRAï¼Ÿï¼‰","value":"-ä¼˜åŠ¿æ€»ç»“ä¸ºå•¥å¤§å®¶éƒ½ç”¨-qlora","line":59,"column":0,"depth":2},"-ä¸¾ä¸ªå¯çˆ±çš„ä¾‹å­":{"type":"header","text":"ğŸ§¸ ä¸¾ä¸ªå¯çˆ±çš„ä¾‹å­ï¼š","value":"-ä¸¾ä¸ªå¯çˆ±çš„ä¾‹å­","line":68,"column":0,"depth":2},"è¦ä¸è¦æ¥è¯•ä¸€ä¸‹-qloraï¸":{"type":"header","text":"è¦ä¸è¦æ¥è¯•ä¸€ä¸‹ QLoRAï¼ŸğŸ› ï¸","value":"è¦ä¸è¦æ¥è¯•ä¸€ä¸‹-qloraï¸","line":78,"column":0,"depth":2}},"children":[],"parent":"9cp08wuyd7t35jzracxxqbv","data":{}},"body":"<h1 id=\"qlora\">qlora<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#qlora\"></a></h1>\n<h2 id=\"-ä»€ä¹ˆæ˜¯-qlora\">ğŸ§  ä»€ä¹ˆæ˜¯ QLoRAï¼Ÿ<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#-ä»€ä¹ˆæ˜¯-qlora\"></a></h2>\n<p><strong>QLoRA = Quantized + LoRA</strong></p>\n<p>ä¸€å¥è¯æ€»ç»“å°±æ˜¯ï¼š</p>\n<blockquote>\n<p>åœ¨<strong>int4 é‡åŒ–æ¨¡å‹çš„åŸºç¡€ä¸Šåš LoRA å¾®è°ƒ</strong>ï¼\nä¸ä»…èŠ‚çœå†…å­˜ï¼Œè¿˜èƒ½è¾¾åˆ°è·Ÿå…¨ç²¾åº¦å¾®è°ƒå·®ä¸å¤šçš„æ•ˆæœâœ¨âœ¨âœ¨</p>\n</blockquote>\n<hr>\n<h2 id=\"-å®ƒæ€ä¹ˆåšçš„å†…éƒ¨æœºåˆ¶è®²è§£-\">ğŸ§© å®ƒæ€ä¹ˆåšçš„ï¼Ÿå†…éƒ¨æœºåˆ¶è®²è§£ ğŸ‘‡<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#-å®ƒæ€ä¹ˆåšçš„å†…éƒ¨æœºåˆ¶è®²è§£-\"></a></h2>\n<h3 id=\"-qlora-æ ¸å¿ƒ-idea\">ğŸ’¡ QLoRA æ ¸å¿ƒ ideaï¼š<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#-qlora-æ ¸å¿ƒ-idea\"></a></h3>\n<ol>\n<li><strong>æŠŠåŸå§‹å¤§æ¨¡å‹æƒé‡ï¼ˆæ¯”å¦‚ LLaMAï¼‰å‹ç¼©ä¸º int4ï¼ˆ4-bitï¼‰</strong></li>\n<li><strong>åªåœ¨ LoRA çš„å° adapter ä¸Šåš float16 ç²¾åº¦çš„æ¢¯åº¦æ›´æ–°</strong></li>\n<li><strong>å¼•å…¥ç²¾å·§çš„ä¼˜åŒ–æœºåˆ¶</strong>é¿å…ç²¾åº¦æŸå¤±ï¼Œæ¯”å¦‚ double quantizationï¼</li>\n</ol>\n<hr>\n<h2 id=\"-qlora-è¯¦ç»†æµç¨‹\">ğŸ§ª QLoRA è¯¦ç»†æµç¨‹<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#-qlora-è¯¦ç»†æµç¨‹\"></a></h2>\n<div class=\"table-responsive\">\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th>é˜¶æ®µ</th><th>å†…å®¹</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>ğŸŒ  1. æƒé‡é‡åŒ–</td><td>ä½¿ç”¨ <strong>NF4ï¼ˆNormalized Float 4ï¼‰</strong> é‡åŒ–æ¨¡å‹</td><td>é«˜ç²¾åº¦çš„ int4 è¡¨ç¤ºï¼Œæ¥è¿‘ float16 è¡¨ç°</td></tr><tr><td>ğŸ’ 2. LoRA æ’å…¥</td><td>åœ¨ attentionã€ffn ç­‰æ¨¡å—æ’å…¥ LoRA adapter</td><td>åªè®­ç»ƒå°éƒ¨åˆ†å‚æ•°ï¼Œçœæ˜¾å­˜</td></tr><tr><td>ğŸ”„ 3. æ¨ç†+è®­ç»ƒèåˆ</td><td>æ¨ç†æ—¶ç”¨ int4 + adapterï¼Œä¸€èµ· forward</td><td>ä¸éœ€è¦è§£ç å› float32</td></tr><tr><td>ğŸ§  4. Double Quantization</td><td>å†æ¬¡å‹ç¼©æƒé‡è¡¨æœ¬èº«</td><td>å‡å°‘å†…å­˜å ç”¨ï¼Œæ›´å¿«åŠ è½½</td></tr></tbody></table></div>\n<hr>\n<h2 id=\"-qlora-vs-lora-vs-gptq\">ğŸ§  QLoRA vs LoRA vs GPTQ<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#-qlora-vs-lora-vs-gptq\"></a></h2>\n<div class=\"table-responsive\">\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th>æ–¹æ³•</th><th>æ¨¡å‹ç²¾åº¦</th><th>å†…å­˜ä½¿ç”¨</th><th>å¯è®­ç»ƒæ€§</th><th>ç”¨é€”</th></tr></thead><tbody><tr><td><strong>LoRA</strong></td><td>float16</td><td>ä¸­ç­‰</td><td>âœ”ï¸</td><td>å¾®è°ƒ</td></tr><tr><td><strong>GPTQ</strong></td><td>int4</td><td>æœ€å°</td><td>âŒï¼ˆä¸èƒ½è®­ç»ƒï¼‰</td><td>æ¨ç†</td></tr><tr><td><strong>QLoRA</strong></td><td>int4 + float16 adapter</td><td>éå¸¸å°</td><td>âœ”ï¸âœ”ï¸âœ”ï¸</td><td>å¾®è°ƒç¥å™¨ï¼</td></tr></tbody></table></div>\n<hr>\n<h2 id=\"-ä½¿ç”¨-qlora-çš„å·¥å…·æ¨è\">ğŸ”§ ä½¿ç”¨ QLoRA çš„å·¥å…·æ¨è<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#-ä½¿ç”¨-qlora-çš„å·¥å…·æ¨è\"></a></h2>\n<ul>\n<li><a href=\"https://github.com/huggingface/peft\">ğŸ¤— <code>peft</code></a> + <code>transformers</code>ï¼šä¸»æµçš„ QLoRA å®ç°</li>\n<li><code>bitsandbytes</code>ï¼šç”¨æ¥æ”¯æŒ int4/NF4 çš„é‡åŒ–æƒé‡åŠ è½½</li>\n<li><code>trl</code>ï¼ˆHuggingface çš„ RLHF å·¥å…·åŒ…ï¼‰ï¼šé…åˆ QLoRA å¯åš SFTã€DPO ç­‰è®­ç»ƒ</li>\n</ul>\n<hr>\n<h2 id=\"-ä¼˜åŠ¿æ€»ç»“ä¸ºå•¥å¤§å®¶éƒ½ç”¨-qlora\">âœ¨ ä¼˜åŠ¿æ€»ç»“ï¼ˆä¸ºå•¥å¤§å®¶éƒ½ç”¨ QLoRAï¼Ÿï¼‰<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#-ä¼˜åŠ¿æ€»ç»“ä¸ºå•¥å¤§å®¶éƒ½ç”¨-qlora\"></a></h2>\n<p>âœ… æ˜¾å­˜ä½ï¼13B æ¨¡å‹å¯åœ¨å•å¼  24GB æ˜¾å¡è®­ç»ƒ\nâœ… å¾®è°ƒæ•ˆæœæ¥è¿‘å…¨å‚å¾®è°ƒï¼ˆç”šè‡³æ›´å¥½ï¼‰\nâœ… æ”¯æŒå¤šç§ä»»åŠ¡ï¼šæ–‡æœ¬ç”Ÿæˆã€åˆ†ç±»ã€QAã€æŒ‡ä»¤å¾®è°ƒç­‰\nâœ… HuggingFace å…¨å®¶æ¡¶æ”¯æŒï¼Œæ˜“ä¸Šæ‰‹ï¼</p>\n<hr>\n<h2 id=\"-ä¸¾ä¸ªå¯çˆ±çš„ä¾‹å­\">ğŸ§¸ ä¸¾ä¸ªå¯çˆ±çš„ä¾‹å­ï¼š<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#-ä¸¾ä¸ªå¯çˆ±çš„ä¾‹å­\"></a></h2>\n<p>æƒ³è±¡ä½ æ˜¯ä¸ªé­”æ³•å¸ˆğŸ§™â€â™€ï¸ï¼ˆå¤§æ¨¡å‹ï¼‰ï¼Œå¹³æ—¶ç©¿è¶…çº§é‡çš„é“ ç”²ï¼ˆfloat32ï¼‰ï¼ŒåŠ¨éƒ½åŠ¨ä¸äº†ğŸ¥²\nLoRA æ˜¯ç»™ä½ è£…ä¸ªå°æŒ‚ä»¶æ¥æ§åˆ¶é­”æ³•âš¡ï¼ˆadapterï¼‰</p>\n<p>è€Œ QLoRA æ˜¯å…ˆæŠŠä½ æ¢ä¸Šè½»å·§çš„ç´§èº«è¡£ï¼ˆint4ï¼‰ï¼Œ\nå†è´´ä¸ªé­”æ³•è´´çº¸ï¼ˆLoRA adapterï¼‰å¸®ä½ ç»ƒå‡ºæ–°æŠ€èƒ½ï¼ï¼æ˜¯ä¸æ˜¯åˆå¿«åˆé…·ï¼ğŸ’¥ğŸ’¥</p>\n<hr>\n<h2 id=\"è¦ä¸è¦æ¥è¯•ä¸€ä¸‹-qloraï¸\">è¦ä¸è¦æ¥è¯•ä¸€ä¸‹ QLoRAï¼ŸğŸ› ï¸<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#è¦ä¸è¦æ¥è¯•ä¸€ä¸‹-qloraï¸\"></a></h2>\n<p>æˆ‘å¯ä»¥å¸®ä½ æ­ä¸€å¥— Huggingface çš„å¾®è°ƒç¯å¢ƒï¼Œè·‘ä¸ªæŒ‡ä»¤å¾®è°ƒä»»åŠ¡ï¼Œæ¯”å¦‚ç”¨ Alpaca æˆ–è€… OpenOrca çš„æ•°æ®ï¼</p>\n<p>æˆ–è€…ç»™ä½ å†™ä¸€æ®µ QLoRA å¾®è°ƒè„šæœ¬ ğŸğŸ’»\næ¯”å¦‚åœ¨ <code>peft</code> + <code>transformers</code> æ¡†æ¶ä¸‹çš„ ğŸ‘‡</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> transformers <span class=\"token keyword\">import</span> AutoModelForCausalLM<span class=\"token punctuation\">,</span> AutoTokenizer\n<span class=\"token keyword\">from</span> peft <span class=\"token keyword\">import</span> prepare_model_for_kbit_training<span class=\"token punctuation\">,</span> LoraConfig<span class=\"token punctuation\">,</span> get_peft_model\n<span class=\"token keyword\">import</span> torch\n\n<span class=\"token comment\"># åŠ è½½é‡åŒ–æ¨¡å‹</span>\nmodel <span class=\"token operator\">=</span> AutoModelForCausalLM<span class=\"token punctuation\">.</span>from_pretrained<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"meta-llama/Llama-2-7b-hf\"</span><span class=\"token punctuation\">,</span>\n    device_map<span class=\"token operator\">=</span><span class=\"token string\">\"auto\"</span><span class=\"token punctuation\">,</span>\n    load_in_4bit<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    quantization_config<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"bnb_4bit_use_double_quant\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># åŠ è½½ tokenizer</span>\ntokenizer <span class=\"token operator\">=</span> AutoTokenizer<span class=\"token punctuation\">.</span>from_pretrained<span class=\"token punctuation\">(</span><span class=\"token string\">\"meta-llama/Llama-2-7b-hf\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># æ’å…¥ LoRA</span>\nmodel <span class=\"token operator\">=</span> prepare_model_for_kbit_training<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">)</span>\npeft_config <span class=\"token operator\">=</span> LoraConfig<span class=\"token punctuation\">(</span>\n    r<span class=\"token operator\">=</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> lora_alpha<span class=\"token operator\">=</span><span class=\"token number\">32</span><span class=\"token punctuation\">,</span> target_modules<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"q_proj\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"v_proj\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    lora_dropout<span class=\"token operator\">=</span><span class=\"token number\">0.05</span><span class=\"token punctuation\">,</span> bias<span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span><span class=\"token punctuation\">,</span> task_type<span class=\"token operator\">=</span><span class=\"token string\">\"CAUSAL_LM\"</span>\n<span class=\"token punctuation\">)</span>\nmodel <span class=\"token operator\">=</span> get_peft_model<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">,</span> peft_config<span class=\"token punctuation\">)</span>\n</code></pre>","noteIndex":{"id":"0f1b48c7-3a25-4016-83a5-15864d7803ad","title":"Development","vault":{"fsPath":"repos/dendron-aws-vault","remote":{"type":"git","url":"https://github.com/cczhong11/my_note.git"},"name":"my_note"},"type":"note","desc":"","links":[{"from":{"fname":"root","id":"c95dc4f5-23db-45e7-a15b-64582a183ccc","vaultName":"my_note"},"type":"backlink","position":{"start":{"line":8,"column":3,"offset":63},"end":{"line":8,"column":21,"offset":81},"indent":[]},"value":"development"}],"anchors":{},"fname":"development","updated":1618381238346,"created":1612940782409,"parent":null,"children":["400115e9-30f7-4a13-9776-db059bc9cd42","xsX5v3ZsyJ0i6gf9","1bc3b45a-b6f4-4150-87d3-5bd5b6eb8c24","6cea4852-6e7c-4140-b476-85c07b48a642","a40ef849-d301-4d74-a778-e6d9469dfb5d","09d9081f-3dff-453d-8488-7d2344cc8895","p11phg7nb10yw0wck1fyagq","92917ea3-452e-48dc-875e-5cd0002041db","2e151826-cb22-4d89-8ce0-71dad7204ce8","baa39444-0da9-4c55-8df7-2a6f8f787fa4","q4um3bc3st86ilkkvdjom6x","62daf50d-a39e-463f-aabd-be53790281fd","3524d0a7-be73-45d6-847e-c970f5c1c760","eac0f243-05b3-4b95-bec3-848e33edbc40","zrjuka02gkzrqxt5djp2aws"],"data":{},"custom":{"nav_order":0,"permalink":"/"},"body":"\n","contentHash":"38357962f5a50c6fd7d318dfa66bea90"},"collectionChildren":null,"customHeadContent":null,"config":{"version":5,"dev":{"previewV2Enabled":false,"enablePreviewV2":true},"commands":{"lookup":{"note":{"selectionMode":"extract","confirmVaultOnCreate":false,"leaveTrace":false,"bubbleUpCreateNew":true,"fuzzThreshold":0.2,"vaultSelectionModeOnCreate":"smart"}},"insertNote":{"initialValue":"templates"},"insertNoteLink":{"aliasMode":"none","enableMultiSelect":false},"insertNoteIndex":{"enableMarker":false},"randomNote":{},"copyNoteLink":{"aliasMode":"title"},"templateHierarchy":"template"},"workspace":{"dendronVersion":"0.90.0","vaults":[{"fsPath":"repos/dendron-aws-vault","remote":{"type":"git","url":"https://github.com/cczhong11/my_note.git"},"name":"my_note"},{"fsPath":"vault"}],"journal":{"dailyDomain":"daily","name":"journal","dateFormat":"y.MM.dd","addBehavior":"childOfDomain"},"scratch":{"name":"scratch","dateFormat":"y.MM.dd.HHmmss","addBehavior":"asOwnDomain"},"graph":{"zoomSpeed":1,"createStub":false},"enableAutoCreateOnDefinition":false,"enableXVaultWikiLink":false,"enableRemoteVaultInit":true,"workspaceVaultSyncMode":"noCommit","enableAutoFoldFrontmatter":true,"maxPreviewsCached":10,"maxNoteLength":204800,"enableUserTags":true,"enableHashTags":true,"task":{"name":"","dateFormat":"","addBehavior":"childOfCurrent","statusSymbols":{"":" ","wip":"w","done":"x","assigned":"a","moved":"m","blocked":"b","delegated":"l","dropped":"d","pending":"y"},"prioritySymbols":{"H":"high","M":"medium","L":"low"},"todoIntegration":false,"createTaskSelectionType":"selection2link","taskCompleteStatus":["done","x"]},"enableEditorDecorations":true,"enableHandlebarTemplates":true,"enableFullHierarchyNoteTitle":false,"enablePersistentHistory":false},"preview":{"enableFMTitle":true,"enableNoteTitleForLink":true,"enableMermaid":true,"enablePrettyRefs":true,"enableKatex":true,"enableFrontmatterTags":true,"enableHashesForFMTags":false,"automaticallyShowPreview":false},"publishing":{"enableFMTitle":true,"enableNoteTitleForLink":true,"enablePrettyRefs":true,"enableKatex":true,"copyAssets":true,"siteHierarchies":["development","life"],"writeStubs":false,"siteRootDir":"docs","seo":{"title":"my_note","description":"Personal knowledge space"},"github":{"enableEditLink":true,"editLinkText":"Edit this page on GitHub","editBranch":"main","editViewMode":"tree"},"enableSiteLastModified":true,"enableFrontmatterTags":true,"enableHashesForFMTags":false,"enableRandomlyColoredTags":true,"enableTaskNotes":true,"enablePrettyLinks":true,"searchMode":"lookup","enableMermaid":true,"siteUrl":"https://notes.tczhong.com","siteFaviconPath":"favicon.ico","siteIndex":"development"}}},"__N_SSG":true}